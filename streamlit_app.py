[...OMITTED HERE FOR BREVITY - same as code above...]